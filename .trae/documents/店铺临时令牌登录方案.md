# 店铺临时令牌登录方案（修改版）

## 1. 需求分析

* 为每个店铺生成6位数字临时令牌
* 令牌每1小时自动刷新
* 方便用户快速登录，减少登录门槛
* 与现有认证系统兼容
* 不修改Shop模型
* 在User模型中定义系统用户
* 最大程度复用现有业务逻辑

## 2. 实现方案

### 2.1 数据模型设计

* **利用现有User模型**：使用Type字段区分系统用户（已支持"system"类型）
* **新增临时令牌表**：创建`TempToken`模型，关联店铺和系统用户

  ```go
  type TempToken struct {
      ID           uint64    `gorm:"primarykey" json:"id"`
      ShopID       uint64    `gorm:"index;not null" json:"shop_id"`
      UserID       uint64    `gorm:"index;not null" json:"user_id"` // 关联系统用户
      Token        string    `gorm:"size:6;not null" json:"token"`  // 6位数字
      ExpiresAt    time.Time `gorm:"index;not null" json:"expires_at"`
      CreatedAt    time.Time `gorm:"column:created_at" json:"created_at"`
      UpdatedAt    time.Time `gorm:"column:updated_at" json:"updated_at"`
  }
  ```

### 2.2 核心功能实现

#### 2.2.1 系统用户创建

* **实现`CreateShopSystemUser`函数**：为每个店铺创建对应的系统用户
* **用户属性**：
  * Type: "system"
  * Role: "public_user"
  * Name: "shop_{shopId}_system"

#### 2.2.2 令牌生成与管理

* **实现`GenerateTempToken`函数**：生成6位随机数字令牌
* **实现`RefreshTempToken`函数**：刷新指定店铺的临时令牌
* **实现`GetValidTempToken`函数**：获取有效令牌，过期则自动刷新

#### 2.2.3 认证流程

1. 用户提供`shopId`和`tempToken`
2. 系统验证令牌有效性
3. 验证通过后，使用关联的系统用户生成JWT令牌
4. 后续请求使用JWT令牌进行认证

#### 2.2.4 API接口实现

* **添加`GET /shop/:shopId/temp-token`**：获取店铺当前有效临时令牌
* **添加`POST /shop/temp-login`**：使用临时令牌登录，返回JWT令牌
* **复用现有JWT认证中间件**：无需修改`FrontendAuthMiddleware`

### 2.3 定时任务

* **实现定时刷新任务**：每小时自动刷新所有店铺的临时令牌
* **使用`cron`库**：系统启动时初始化定时任务

## 3. 实现步骤

1. **新增临时令牌模型**：在`models/temp_token.go`中创建`TempToken`模型
2. **实现系统用户管理**：在`handlers/shop.go`中实现系统用户创建逻辑
3. **实现临时令牌生成工具**：在`utils/token.go`中实现6位数字令牌生成
4. **实现临时令牌管理服务**：在`services/temp_token.go`中实现令牌生成、刷新和验证
5. **实现API接口**：在`handlers/auth.go`和`handlers/shop.go`中添加相关接口
6. **实现定时刷新任务**：在`services/temp_token.go`中实现定时刷新逻辑
7. **在系统启动时初始化**：在`main.go`中添加定时任务初始化

## 4. 安全考虑

* 6位数字令牌安全性适中，适合快速登录场景
* 令牌每小时自动刷新，降低泄露风险
* 临时令牌仅用于获取JWT，后续请求使用JWT认证
* 系统用户与店铺一一对应，权限控制明确

## 5. 兼容性

* 不修改任何现有模型结构
* 复用现有JWT认证中间件
* 不影响现有API接口
* 支持渐进式部署

## 6. 代码结构

```
src/
├── models/
│   ├── user.go              # 复用现有用户模型
│   └── temp_token.go        # 新增：临时令牌模型
├── utils/
│   ├── jwt.go               # 复用现有JWT工具
│   └── token.go             # 新增：临时令牌生成工具
├── middleware/
│   └── auth.go              # 复用现有认证中间件
├── handlers/
│   ├── auth.go              # 新增：临时令牌登录接口
│   └── shop.go              # 新增：获取临时令牌接口
├── services/
│   └── temp_token.go        # 新增：临时令牌管理服务
└── main.go                  # 修改：初始化定时任务
```

## 7. 业务流程

### 7.1 系统初始化

1. 为每个店铺创建系统用户
2. 为每个店铺生成初始临时令牌
3. 启动定时刷新任务

### 7.2 用户登录流程

1. 用户获取店铺临时令牌（通过店铺展示或API）
2. 用户使用`shopId`和`tempToken`调用`/shop/temp-login`接口
3. 系统验证临时令牌有效性
4. 验证通过后，使用关联的系统用户生成JWT令牌
5. 用户使用JWT令牌访问其他API接口

### 7.3 令牌刷新流程

1. 定时任务每小时触发一次
2. 遍历所有临时令牌记录
3. 为每个记录生成新的6位令牌
4. 更新令牌过期时间为当前时间+1小时
5. 保存更新后的令牌记录

## 8. 复用现有业务逻辑

* 复用现有JWT生成和验证逻辑
* 复用现有用户认证中间件
* 复用现有用户管理逻辑
* 复用现有店铺查询逻辑
* 复用现有数据库连接池

这个方案完全符合用户要求，不修改Shop模型，在User模型中使用系统用户，最大程度复用现有业务逻辑，同时实现了临时令牌登录功能。